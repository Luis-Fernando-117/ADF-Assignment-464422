---
title: "ADF Individual Assignment Report"
author: "Luis F. Barros - 464422"
date: "Last compiled on `r Sys.Date()`"
output: 
    bookdown::html_document2:
        toc: true
        toc_float: 
            collapsed: false
        number_sections: true
        code_folding: hide
        theme: cerulean
editor_options: 
  chunk_output_type: console
---
# Introduction 

For this notebook, it is needed to load an R.Data file containing all the raw 
information from Twitter that I got from "collect_data.R" script. 
The output should be another .RData file with the preprocessed data that has the data converted
into data frames ready to analyze.

# Data aquisition and processing

# Data Analysis 

Load Libraries 
```{r, message=FALSE }
library("httr")
library("jsonlite")
library("tidyverse")
library("twitteR")
library("rtweet")
library("plyr")
library("dplyr")
library("data.table")
library("tidytext")
library("textdata")
library("udpipe")
library("ggplot2")
library("hrbrthemes")
library("lattice")
```

Load Objects
```{r}
# Followers tweets
  load("text.tweets.obrador.followers.RData")
  load("text.tweets.pinera.followers.RData")
  load("text.tweets.lenin.followers.RData")
  load("text.tweets.bukele.followers.RData")
  
# Presidents Tweets
  load("text.tweets.obrador.RData")
  load("text.tweets.pinera.RData")
  load("text.tweets.lenin.RData")
  load("text.tweets.bukele.RData")
```

Final Data Preparation

Convert all the tweets text to lowercase
```{r}
# For followers
text.tweets.obrador.followers$text <- tolower(text.tweets.obrador.followers$text)
text.tweets.pinera.followers$text  <- tolower(text.tweets.pinera.followers$text)
text.tweets.lenin.followers$text   <- tolower(text.tweets.lenin.followers$text)
text.tweets.bukele.followers$text  <- tolower(text.tweets.bukele.followers$text)

# For presidents tweets
text.tweets.obrador$text <- tolower(text.tweets.obrador$text)
text.tweets.pinera$text  <- tolower(text.tweets.pinera$text)
text.tweets.lenin$text   <- tolower(text.tweets.lenin$text)
text.tweets.bukele$text  <- tolower(text.tweets.bukele$text)
```

Calculate the length of each tweets
```{r}
# For followers tweets 
text.tweets.obrador.followers$length <- 
  sapply(strsplit(text.tweets.obrador.followers$text, " "), length)

text.tweets.pinera.followers$length <- 
  sapply(strsplit(text.tweets.pinera.followers$text, " "), length)

text.tweets.lenin.followers$length <- 
  sapply(strsplit(text.tweets.lenin.followers$text, " "), length)

text.tweets.bukele.followers$length <- 
  sapply(strsplit(text.tweets.bukele.followers$text, " "), length)

# For presidents tweets 
text.tweets.obrador$length <- 
  sapply(strsplit(text.tweets.obrador$text, " "), length)

text.tweets.pinera$length <- 
  sapply(strsplit(text.tweets.pinera$text, " "), length)

text.tweets.lenin$length <- 
  sapply(strsplit(text.tweets.lenin$text, " "), length)

text.tweets.bukele$length <- 
  sapply(strsplit(text.tweets.bukele$text, " "), length)
```

## Data visualizations

Bind all the tweets texts into a single df
```{r}
# For followers tweets
df.tweets.visualization <- rbind(text.tweets.obrador.followers, text.tweets.pinera.followers)
df.tweets.visualization <- rbind(df.tweets.visualization, text.tweets.lenin.followers)
df.tweets.visualization <- rbind(df.tweets.visualization, text.tweets.bukele.followers )
df.tweets.visualization$line <- NULL

# For presidents tweets
df.presidents.tweets.visualization <- rbind(text.tweets.obrador, text.tweets.lenin)
df.presidents.tweets.visualization <- rbind(df.presidents.tweets.visualization, 
                                            text.tweets.pinera)
df.presidents.tweets.visualization <- rbind(df.presidents.tweets.visualization,
                                            text.tweets.bukele)
df.presidents.tweets.visualization$line <- NULL
```

Make a single histogram of the tweet lenghts 
```{r}
# For followers tweets 
hist.followers.tweet.lenghts <- ggplot(df.tweets.visualization) + 
  geom_histogram(aes(x = length, fill = doc_id) , alpha = 0.6, bins = 30)
hist.followers.tweet.lenghts
```

```{r}
# For presidents tweets
hist.presidents.tweet.lenghts <- ggplot(df.presidents.tweets.visualization) + 
  geom_histogram(aes(x = length, fill = doc_id) , alpha = 0.6, bins = 30)
hist.presidents.tweet.lenghts
```


We can also calculate some basics statistics of the timelines of the presidents 
! I need to load the actual time lines from the "collect data" file
```{r}
# Get some features out of the tmls data frame
average_text_with <- mean(tmls$display_text_width)
average_retweet_count <- mean(tmls$retweet_count)

```


## Text Mining with "Udpipe" package

## Analysis of followers tweets
Define the language of the analysis
```{r}
udmodel <- udpipe_download_model(language = "spanish")
udmodel
```

Deploy the package to tokenise, and tag terms in all the tweets from presidents
followers
```{r}
udmodel.obrador.followers <- udpipe(x = text.tweets.obrador.followers$text, 
                                    object = udmodel)
udmodel.pinera.followers  <- udpipe(x = text.tweets.pinera.followers$text, 
                                    object = udmodel)
udmodel.lenin.followers   <- udpipe(x = text.tweets.lenin.followers$text, 
                                    object = udmodel)
udmodel.bukele.followers  <- udpipe(x = text.tweets.bukele.followers$text, 
                                    object = udmodel)
```


Filter the data frames to exclude stop words, punctuation and symbols

To check the definitions of the upos categories, check
https://universaldependencies.org/u/pos/index.html

```{r}
udmodel.obrador.followers.filtered <- filter(udmodel.obrador.followers, 
                                             upos == "ADJ" | upos == "NOUN" |
                                             upos == "PROPN" | upos == "INTJ")
udmodel.obrador.followers.filtered <- filter(udmodel.obrador.followers.filtered, 
                                             !grepl("@", token))

udmodel.pinera.followers.filtered  <- filter(udmodel.pinera.followers, 
                                             upos == "ADJ" | upos == "NOUN" |
                                             upos == "PROPN" | upos == "INTJ")
udmodel.pinera.followers.filtered <- filter(udmodel.pinera.followers.filtered, 
                                             !grepl("@", token))

udmodel.lenin.followers.filtered   <- filter(udmodel.lenin.followers, 
                                             upos == "ADJ" | upos == "NOUN" |
                                             upos == "PROPN" | upos == "INTJ")
udmodel.lenin.followers.filtered <- filter(udmodel.lenin.followers.filtered, 
                                             !grepl("@", token))
                                            
udmodel.bukele.followers.filtered  <- filter(udmodel.bukele.followers, 
                                             upos == "ADJ" | upos== "NOUN" |
                                             upos == "PROPN" | upos == "INTJ")
udmodel.bukele.followers.filtered <- filter(udmodel.bukele.followers.filtered, 
                                             !grepl("@", token))
```

Term Frequency of followers tweets
```{r}
term.frequency.obrador.followers         <- txt_freq(udmodel.obrador.followers.filtered$token) 
term.frequency.obrador.followers$country <- "Mexico"

term.frequency.pinera.followers          <- txt_freq(udmodel.pinera.followers.filtered$token)
term.frequency.pinera.followers$country  <- "Chile"

term.frequency.lenin.followers           <- txt_freq(udmodel.lenin.followers.filtered$token)
term.frequency.lenin.followers$country   <- "Ecuador"

term.frequency.bukele.followers          <- txt_freq(udmodel.bukele.followers.filtered$token)
term.frequency.bukele.followers$country  <- "El Salvador"


# Merging rows into a single data frame
countries.term.frequncies <- rbind(term.frequency.obrador.followers, term.frequency.pinera.followers)
countries.term.frequncies <- rbind(countries.term.frequncies, term.frequency.lenin.followers)
countries.term.frequncies <- rbind(countries.term.frequncies, term.frequency.bukele.followers)
```

Visualize top 20 terms used by presidents followers 
```{r}
# Mexico
factor(term.frequency.obrador.followers$key, 
                    levels = rev(term.frequency.obrador.followers$key))
      barchart(key ~ freq, data = head(term.frequency.obrador.followers, 20), col = "cadetblue", 
         main = "Most occurring terms", xlab = "Freq")

# Chile
factor(term.frequency.pinera.followers$key, 
                    levels = rev(term.frequency.pinera.followers$key))
barchart(key ~ freq, data = head(term.frequency.pinera.followers, 20), col = "cadetblue", 
         main = "Most occurring terms", xlab = "Freq")

# Ecuador
factor(term.frequency.lenin.followers$key, 
                    levels = rev(term.frequency.lenin.followers$key))
barchart(key ~ freq, data = head(term.frequency.lenin.followers, 20), col = "cadetblue", 
         main = "Most occurring terms", xlab = "Freq")

# El Salvador
factor(term.frequency.bukele.followers$key, 
                    levels = rev(term.frequency.bukele.followers$key))
barchart(key ~ freq, data = head(term.frequency.bukele.followers, 20), col = "cadetblue", 
         main = "Most occurring terms", xlab = "Freq")

```

Get emotions from public defined dictionaries of words and its emotions
```{r}
link <- "https://raw.githubusercontent.com/JoseCardonaFigueroa/sentiment-analysis-spanish/master/data/emotions.csv"
spanish_emotions <- read_csv(link)
# Renaming columns
names(spanish_emotions)[1] <- "key"
names(spanish_emotions)[2] <- "emotion"
```

Paste the emotion to the Term Frequency df
```{r}
emotion.score.followers <- left_join(countries.term.frequncies, spanish_emotions, by = c("key"))
emotion.score.followers <- as.data.table(na.omit(emotion.score.followers))
emotion.score.followers <- emotion.score.followers[ , list(tot_freq = sum(freq), terms_per_emotion = .N), 
                                by = c("emotion", "country")]
```

Visualize prevalence of emotions of followers
```{r}
# Stacked
emotions_stacked_plot <- ggplot(emotion.score.followers, 
                                aes(fill=country, y=tot_freq, x=emotion)) + 
                                geom_bar(position="stack", stat="identity")

emotions_stacked_plot
```


## Analysis of presidents tweets
```{r}
udmodel.obrador        <- udpipe(x = text.tweets.obrador$text, 
                                    object = udmodel)
udmodel.obrador$doc_id <- "Mexico"

udmodel.pinera         <- udpipe(x = text.tweets.pinera$text, 
                                    object = udmodel)
udmodel.pinera$doc_id  <- "Chile"

udmodel.lenin          <- udpipe(x = text.tweets.lenin$text, 
                                    object = udmodel)
udmodel.lenin$doc_id   <- "Ecuador"

udmodel.bukele         <- udpipe(x = text.tweets.bukele$text, 
                                    object = udmodel)
udmodel.bukele$doc_id  <- "El Salvador"

```
Merge them into a single data frame to then filter more easily
```{r}
umodel.presidents <- rbind(udmodel.obrador, udmodel.pinera)
umodel.presidents <- rbind(umodel.presidents,udmodel.lenin)
umodel.presidents <- rbind(umodel.presidents,udmodel.bukele)
```

```{r}
umodel.presidents.filtered <- filter(umodel.presidents, 
                                             upos == "ADJ" | upos == "NOUN" |
                                             upos == "PROPN" | upos == "INTJ")
umodel.presidents.filtered <- filter(umodel.presidents.filtered, 
                                             !grepl("@", token))
```


# Discussion 

## Limitations 
- Small sample size due to procesing time
- Sample is biased in the last 9 days of when tweets were collected, so not representative

# References 

https://www.tidytextmining.com/sentiment.html
https://bnosac.github.io/udpipe/docs/doc5.html
https://www.r-graph-gallery.com/48-grouped-barplot-with-ggplot2.html
http://www.consulta.mx/index.php/encuestas-e-investigaciones/el-mundo
